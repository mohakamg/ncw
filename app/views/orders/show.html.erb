<script>
$(document).ready(function()
{
  $('#order_website').pastableTextarea();

  $('#order_website').on('pasteImage', function (ev, data){
    //console.log("dataURL: " + data.dataURL);
    ev.preventDefault();
    console.log("width: " + data.width);
    console.log("height: " + data.height);
    console.log(data.blob);
    $.ajax({
      type: "POST",
      beforeSend: function() {
        console.log("Sending AJAX");
      },
      url: "/pastedImage/<%= @order.id %>/image/",
      data: {pastedImage: data.dataURL}
    });

    $('#order_website').after('<img class=\"result \" src='+ data.dataURL +'>');
  }).on('pasteImageError', function(ev, data){
    alert('Oops: ' + data.message);
    if(data.url){
      alert('But we got its url anyway:' + data.url)
    }
  }).on('pasteText', function (ev, data){
    console.log("text: " + data.text);
  });
});
</script>


<div class="container">
    <% if student_logged_in? %>
      <% if @order.teacher_id != 0 %>
        <h1>Order Attended By: <%= @order.teacher.first_name %></h1>
        <h3>Status Of Order: <%= @order.status %></h3>
      <% else %>
        <h1>Order Waiting to be Accepted</h1>
      <% end %>
        <% if @order.approved_completion %>
            </h1>
            <p>Subject: <%= @order.subject %></p>
            <p>Topic: <%= @order.topic %></p>
            <p>Placed On: <%= @order.created_at %></p>
            <p>Status: <%= @order.status %></p>
            <p>Deadline: <%= @order.deadline %></p>
            <p>Extra Comments: <%= @order.special_comments %></p>
            <h2 class="text-center">Approved Completion: <%= @order.approved_completion.to_s.titleize %></h2>


            <% @order.stud_docs.each do |f| %>
              <br><%= link_to f.to_s, f.url %><br>
            <% end %>
            <br>
            <% @order.stud_pasted_images.each do |f| %>
              <a href="<%= f %>"><%= image_tag f, class: "result" %></a>
            <% end %>
            <br>
            Teacher Uploads:
            <% @order.teacher_docs.each do |f| %>
              <br><%= link_to f.path.to_s, f.url %><br>
            <% end %>

        <% else %>
            <h3>My Uploads:</h3>
            <% @order.stud_docs.each do |f| %>
              <br><%= link_to f.path.to_s, f.url %><br>
            <% end %>

              <br>
              <% @order.stud_pasted_images.each do |f| %>
                <a href="<%= f %>"><%= image_tag f, class: "result" %></a>
              <% end %>
              <br><hr>
            <h3>Teacher Uploads:</h3>
            <% @order.teacher_docs.each do |f| %>
              <br><%= link_to f.path.to_s, f.url %><br>
            <% end %>
            <br><hr>
            <%= form_for [@student, @order], method: :patch do |f| %>
                <% if @order.errors.any? %>
                  <h1><%= pluralize(@order.errors.count, "Errors") %> Prevented Your Order Creation </h1>
                    <% @order.errors.full_messages.each do |e| %>
                      <li><%= e %></li>
                    <% end %>
                <% end %>

                <h3>Subject: <%= @order.subject %></h3><br><hr>
                <h3>Topic: <%= @order.topic %></h3><br><hr>

                <div class="form-group">
                    <%= f.label "About Homework" %><br>
                    <%= f.text_area :about_homework, default: @order.about_homework, class:"form-control" %>
                </div>

                <div class="form-group">
                    <%= f.label "Website For HW/Screenshots" %><br>
                    <%= f.text_field :website, default: @order.website.to_s, class:"form-control" %>
                </div>

                <div class="form-group">
                    <%= f.label "Crdentials for Website" %><br>
                    <%= f.text_area :credentials, default: @order.credentials.to_s, class:"form-control" %>
                </div>

                <div class="form-group">
                    <%= f.label "Extra Comments" %><br>
                    <%= f.text_area :special_comments, default: @order.special_comments, class:"form-control" %>
                </div>

                <div class="form-group">
                    <%= f.label :approved_completion, "Approve Completion" %><br>
                    <%= f.check_box :approved_completion %>
                </div>

                <div class="form-group">
                    <%= f.label "Upload More Docs (You Can Upload Multiple Docs With Multiple Select)" %><br>
                    <%= f.file_field :stud_docs, multiple: true, class: "form-control" %>
                </div>

                <%= f.submit "Update Status of Order", class: "btn btn-success" %>
            <% end %>

        <% end %>

      <% end %>

    <% if teacher_logged_in? %>

      <h1><%= @order.student.username %></h1>
      <p>Subject: <%= @order.subject %></p>
      <p>Topic: <%= @order.topic %></p>
      <p>Placed On: <%= @order.created_at %></p>
      <p>Deadline: <%= @order.deadline %></p>
      <p>Extra Comments: <%= @order.special_comments %></p>
      <h2 class="text-center">Approved Completion: <%= @order.approved_completion.to_s.titleize %></h2>
      Student Uploads:
      <% @order.stud_docs.each do |f| %>
        <br><%= link_to f.path.to_s, f.url %><br>
      <% end %>

      <br>
      <% @order.stud_pasted_images.each do |f| %>
        <a href="<%= f %>"><%= image_tag f, class: "result" %></a>
      <% end %>
      <br>

      <% if @order.teacher_id == current_teacher.id %>
        Your Uploads:
        <% @order.teacher_docs.each do |f| %>
          <br><%= link_to f.path.to_s, f.url %><br>
        <% end %>
      <% end %>



      <% if @order.teacher == current_teacher && !@order.approved_completion %>

        <%= form_for [@teacher, @order], method: :patch do |f| %>

            <div class="form-group">
              <%= f.label "Status" %><br>
              <%= f.select :status, options_for_select(["Accepted. In Progress", "Completed"], @order.status), class: "form-control" %>
            </div>

            <div class="form-group">
                <%= f.label "Upload Docs (You Can Upload Multiple Docs With Multiple Select)" %><br>
                <%= f.file_field :teacher_docs, multiple: true, class: "form-control" %>
            </div>

            <%= f.submit "Update Status of Order", class: "btn btn-success" %>

        <% end %>

    <% end %>

  <% end %>


</div>
